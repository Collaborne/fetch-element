<!--
@license
Copyright (c) 2015 Glenn Vandeuren. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<script>
  if (!Promise) {
    document.write('<script src="../es6-promise/dist/es6-promise.js"><\\/script>');
  }
  if (!fetch) {
    document.write('<script src="../fetch/fetch.js"><\\/script>');
  }
</script>

<!--
An element wrapping [Fetch](https://github.com/github/fetch).

Example:

    <fetch-element></fetch-element>

@demo
-->

<script>

  Polymer({

    is: 'fetch-element',

    properties: {

      url: {
        type: String
      },

      headers: {
        type: Object
      },

      /**
      * Set method to post for writing data to JSON.
      */
      method: {
        type: String
      },

      /**
      * the object to add
      */
      body: {
        type: Object,
        value: undefined
      },

      type: {
        type: String
      },

      data: {
        type: Object,
        notify: true
      },

      auto: {
        type: Boolean,
        reflectToAttribute: true
      }

    },

    observers: [
      'fetch(body, headers, auto)'
    ],

    // Element Lifecycle

    attached: function() {
      this._status = function (response) {
        if (response.status >= 200 && response.status < 300) {
          return Promise.resolve(response)
        } else {
          return Promise.reject(new Error(response.statusText))
        }
      },

      this._json = function (response) {
        return response.json()
      },

      this._responseData = function (data) {
        return this.data = data;;
      }.bind(this);

      if (this.method !== 'post' && this.auto) {
        this.fetch();
      }
    },

    // Element Behavior

    fetch: function () {
      this.params = {};
      this.params.headers = this.headers;

      if (this.method) {
        this.params.method = this.method;
        if (this.method === 'post') {
          this.params.body = this.body;
        }
      }

      fetch(this.url, this.params)
        .then(this._status)
        .then(this._json)
        .then(this._responseData)
        .catch(function(error) {
          console.log('Request failed', error)
      }.bind(this));
    }


  });

</script>
